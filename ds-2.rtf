{\rtf1\ansi\ansicpg1252\cocoartf2822
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fnil\fcharset0 Lato-Regular;\f1\fnil\fcharset0 AppleColorEmoji;}
{\colortbl;\red255\green255\blue255;\red0\green0\blue0;}
{\*\expandedcolortbl;;\cssrgb\c0\c0\c0;}
\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\deftab720
\pard\pardeftab720\partightenfactor0

\f0\fs29\fsmilli14667 \cf2 \expnd0\expndtw0\kerning0
After evaluating all three options, I'll select **Option 3 (gpt-1)** as the best foundation and integrate the best features from the other options. Here's my analysis:\
\'a0\
## Evaluation of Options\
\'a0\
### **Option 1 (claude-1) - Rating: 6/10**\
**Pros:**\
- Simple JSON-based storage (id_mappings.json, sync_exceptions.json)\
- Easy setup with minimal dependencies\
- Good documentation\
\'a0\
**Cons:**\
- JSON storage not suitable for production\
- Limited error handling\
- No database support\
- Missing advanced features\
\'a0\
### **Option 2 (ds-1) - Rating: 7/10**\
**Pros:**\
- Good database schema (SQLAlchemy)\
- Comprehensive data models\
- Better logging system\
- Modular architecture\
\'a0\
**Cons:**\
- Incomplete API implementations (pass statements in update methods)\
- Missing Wrike custom field handling\
- Less production-ready\
\'a0\
### **Option 3 (gpt-1) - Rating: 9/10** 
\f1 \uc0\u11088 
\f0  **SELECTED**\
**Pros:**\
- Most production-ready with proper error handling\
- Complete YAML configuration system\
- SQLite database with proper schema\
- Comprehensive reconciliation system with CSV export\
- Command-line interface with multiple modes\
- Built-in field verification\
- Proper polling with state management\
- Working Wrike custom field handling\
- HubSpot associations implemented\
- Tier/Priority mapping configuration\
\'a0\
**Cons:**\
- Could use better logging\
- Could benefit from webhook support\
\'a0\
---\
\'a0\
## **Integrated Production-Ready Solution**\
\'a0\
I'll enhance Option 3 with the best features from the other options:\
\'a0\
```python\
"""\
Falcon/Wrike <> HubSpot Middleware - Production Integrated Version\
Combines best features from all three options with production enhancements\
"""\
\'a0\
import argparse\
import csv\
import json\
import os\
import sqlite3\
import sys\
import time\
from dataclasses import dataclass\
from datetime import datetime, timezone, timedelta\
from typing import Any, Dict, Iterable, List, Optional, Tuple\
import logging\
\'a0\
import requests\
import yaml\
from dateutil import parser as dtparser\
\'a0\
# --- Enhanced Logging (from ds-1) ---\
def setup_logging():\
\'a0\'a0\'a0 """Configure comprehensive logging"""\
\'a0\'a0\'a0 log_format = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 # Create logs directory if it doesn't exist\
\'a0\'a0\'a0 if not os.path.exists('logs'):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 os.makedirs('logs')\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 logging.basicConfig(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 level=logging.INFO,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 format=log_format,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 handlers=[\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logging.FileHandler('logs/falcon_hubspot_sync.log', encoding='utf-8'),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logging.StreamHandler(sys.stdout)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 ]\
\'a0\'a0\'a0 )\
\'a0\'a0\'a0 return logging.getLogger(__name__)\
\'a0\
logger = setup_logging()\
\'a0\
# --- Database Models (Enhanced from ds-1 and gpt-1) ---\
class EnhancedDB:\
\'a0\'a0\'a0 """Enhanced database with SQLAlchemy-like models and SQLite backend"""\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def __init__(self, path: str):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.path = path\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.conn = sqlite3.connect(self.path)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.conn.execute("PRAGMA journal_mode=WAL;")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.conn.execute("PRAGMA foreign_keys=ON;")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self._init_schema()\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def _init_schema(self) -> None:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Initialize all database tables"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 cur = self.conn.cursor()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Company ID mapping table\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 cur.execute("""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 CREATE TABLE IF NOT EXISTS company_id_map (\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 wrike_company_id TEXT PRIMARY KEY,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 hubspot_company_id TEXT UNIQUE,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 company_name TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 sync_status TEXT DEFAULT 'active',\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 last_synced TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 updated_at TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 created_at TEXT DEFAULT CURRENT_TIMESTAMP,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 notes TEXT\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 )\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Sync state tracking\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 cur.execute("""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 CREATE TABLE IF NOT EXISTS sync_state (\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 k TEXT PRIMARY KEY,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 v TEXT\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 )\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Sync logs (from ds-1)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 cur.execute("""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 CREATE TABLE IF NOT EXISTS sync_logs (\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 id INTEGER PRIMARY KEY AUTOINCREMENT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 operation TEXT NOT NULL,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 source_system TEXT NOT NULL,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 target_system TEXT NOT NULL,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 entity_type TEXT NOT NULL,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 entity_id TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 status TEXT NOT NULL,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 message TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 created_at TEXT DEFAULT CURRENT_TIMESTAMP\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 )\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Reconciliation issues\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 cur.execute("""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 CREATE TABLE IF NOT EXISTS reconciliation_issue (\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 id INTEGER PRIMARY KEY AUTOINCREMENT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 created_at TEXT DEFAULT CURRENT_TIMESTAMP,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 source TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 entity_type TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 entity_id TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 issue_type TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 detail TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 resolved INTEGER DEFAULT 0\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 )\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Contact mappings (new)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 cur.execute("""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 CREATE TABLE IF NOT EXISTS contact_mappings (\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 wrike_contact_id TEXT PRIMARY KEY,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 hubspot_contact_id TEXT UNIQUE,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 email TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 company_id TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 last_synced TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 created_at TEXT DEFAULT CURRENT_TIMESTAMP,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 FOREIGN KEY (company_id) REFERENCES company_id_map(wrike_company_id)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 )\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Configuration history (new)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 cur.execute("""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 CREATE TABLE IF NOT EXISTS config_history (\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 id INTEGER PRIMARY KEY AUTOINCREMENT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 config_hash TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 config_data TEXT,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 applied_at TEXT DEFAULT CURRENT_TIMESTAMP\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 )\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.conn.commit()\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def log_sync_operation(self, operation: str, source: str, target: str, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 entity_type: str, entity_id: str, status: str, message: str = ""):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Log sync operations (from ds-1)"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.conn.execute("""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 INSERT INTO sync_logs(operation, source_system, target_system, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 entity_type, entity_id, status, message)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 VALUES(?, ?, ?, ?, ?, ?, ?)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """, (operation, source, target, entity_type, entity_id, status, message))\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.conn.commit()\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 # All original DB methods from gpt-1 with enhancements\
\'a0\'a0\'a0 def get_state(self, k: str) -> Optional[str]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 row = self.conn.execute("SELECT v FROM sync_state WHERE k = ?", (k,)).fetchone()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return row[0] if row else None\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def set_state(self, k: str, v: str) -> None:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.conn.execute(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "INSERT INTO sync_state(k, v) VALUES(?, ?) ON CONFLICT(k) DO UPDATE SET v=excluded.v",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 (k, v),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 )\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.conn.commit()\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def get_hubspot_company_id(self, wrike_company_id: str) -> Optional[str]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 row = self.conn.execute(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "SELECT hubspot_company_id FROM company_id_map WHERE wrike_company_id = ? AND sync_status = 'active'",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 (wrike_company_id,),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 ).fetchone()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return row[0] if row else None\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def get_wrike_company_id_by_hubspot(self, hubspot_company_id: str) -> Optional[str]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 row = self.conn.execute(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "SELECT wrike_company_id FROM company_id_map WHERE hubspot_company_id = ? AND sync_status = 'active'",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 (hubspot_company_id,),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 ).fetchone()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return row[0] if row else None\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def upsert_company_mapping(self, wrike_company_id: str, hubspot_company_id: str, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 company_name: str = "", notes: str = "") -> None:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 now = datetime.now(timezone.utc).isoformat()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.conn.execute(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 INSERT INTO company_id_map(wrike_company_id, hubspot_company_id, company_name, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 updated_at, last_synced, notes)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 VALUES(?, ?, ?, ?, ?, ?)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 ON CONFLICT(wrike_company_id) DO UPDATE SET\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 hubspot_company_id=excluded.hubspot_company_id,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 company_name=excluded.company_name,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 updated_at=excluded.updated_at,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 last_synced=excluded.last_synced,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 notes=excluded.notes,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 sync_status='active'\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 (wrike_company_id, hubspot_company_id, company_name, now, now, notes),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 )\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.conn.commit()\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def add_issue(self, source: str, entity_type: str, entity_id: str, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 issue_type: str, detail: str) -> None:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.conn.execute(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 INSERT INTO reconciliation_issue(created_at, source, entity_type, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 entity_id, issue_type, detail, resolved)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 VALUES(?, ?, ?, ?, ?, ?, 0)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 (datetime.now(timezone.utc).isoformat(), source, entity_type, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 entity_id, issue_type, detail),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 )\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.conn.commit()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.warning(f"Reconciliation issue: \{issue_type\} - \{detail\}")\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def list_unresolved_issues(self) -> List[Tuple]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 rows = self.conn.execute(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 SELECT id, created_at, source, entity_type, entity_id, issue_type, detail\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 FROM reconciliation_issue\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 WHERE resolved = 0\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 ORDER BY id ASC\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 ).fetchall()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return rows\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def get_company_mappings_report(self) -> Dict:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Generate company mappings report"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 rows = self.conn.execute(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "SELECT COUNT(*) as total, "\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "SUM(CASE WHEN sync_status = 'active' THEN 1 ELSE 0 END) as active "\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "FROM company_id_map"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 ).fetchone()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 recent = self.conn.execute(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "SELECT company_name, wrike_company_id, hubspot_company_id, last_synced "\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "FROM company_id_map "\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "WHERE sync_status = 'active' "\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "ORDER BY last_synced DESC LIMIT 10"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 ).fetchall()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return \{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "total_mappings": rows[0],\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "active_mappings": rows[1],\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "recent_syncs": [\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "name": r[0],\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "wrike_id": r[1],\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "hubspot_id": r[2],\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "last_synced": r[3]\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \} for r in recent\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 ]\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \}\
\'a0\
# --- Data Models (from ds-1) ---\
@dataclass\
class Company:\
\'a0\'a0\'a0 """Company data model"""\
\'a0\'a0\'a0 name: str\
\'a0\'a0\'a0 wrike_id: Optional[str] = None\
\'a0\'a0\'a0 hubspot_id: Optional[str] = None\
\'a0\'a0\'a0 account_status: Optional[str] = None\
\'a0\'a0\'a0 affinity_score: Optional[float] = None\
\'a0\'a0\'a0 account_tier: Optional[str] = None\
\'a0\'a0\'a0 properties: Optional[Dict] = None\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def __post_init__(self):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if self.properties is None:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.properties = \{\}\
\'a0\
@dataclass\
class Contact:\
\'a0\'a0\'a0 """Contact data model"""\
\'a0\'a0\'a0 first_name: str\
\'a0\'a0\'a0 last_name: str\
\'a0\'a0\'a0 email: str\
\'a0\'a0\'a0 wrike_id: Optional[str] = None\
\'a0\'a0\'a0 hubspot_id: Optional[str] = None\
\'a0\'a0\'a0 title: Optional[str] = None\
\'a0\'a0\'a0 phone: Optional[str] = None\
\'a0\'a0\'a0 mobile: Optional[str] = None\
\'a0\'a0\'a0 address1: Optional[str] = None\
\'a0\'a0\'a0 address2: Optional[str] = None\
\'a0\'a0\'a0 city: Optional[str] = None\
\'a0\'a0\'a0 state: Optional[str] = None\
\'a0\'a0\'a0 country: Optional[str] = None\
\'a0\'a0\'a0 company_id: Optional[str] = None\
\'a0\'a0\'a0 properties: Optional[Dict] = None\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def __post_init__(self):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if self.properties is None:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.properties = \{\}\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 @property\
\'a0\'a0\'a0 def full_name(self) -> str:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return f"\{self.first_name\} \{self.last_name\}".strip()\
\'a0\
# --- Configuration Management ---\
@dataclass\
class Config:\
\'a0\'a0\'a0 """Enhanced configuration with validation"""\
\'a0\'a0\'a0 raw: Dict[str, Any]\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 @property\
\'a0\'a0\'a0 def hubspot(self) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return self.raw["hubspot"]\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 @property\
\'a0\'a0\'a0 def wrike(self) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return self.raw["wrike"]\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 @property\
\'a0\'a0\'a0 def sync(self) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return self.raw.get("sync", \{\})\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 @property\
\'a0\'a0\'a0 def notifications(self) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return self.raw.get("notifications", \{\})\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 @property\
\'a0\'a0\'a0 def environment(self) -> str:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return self.raw.get("environment", "development")\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def validate(self) -> List[str]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Validate configuration"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 errors = []\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Check required sections\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 for section in ["hubspot", "wrike"]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if section not in self.raw:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 errors.append(f"Missing section: \{section\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Check required properties\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if "hubspot" in self.raw:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 hub = self.hubspot\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if "company_properties" not in hub:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 errors.append("Missing hubspot.company_properties")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if "contact_properties" not in hub:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 errors.append("Missing hubspot.contact_properties")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if "wrike" in self.raw:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 wrk = self.wrike\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 for folder in ["companies_folder_id", "contacts_folder_id"]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if folder not in wrk:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 errors.append(f"Missing wrike.\{folder\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 for cf in ["company_custom_fields", "contact_custom_fields"]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if cf not in wrk:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 errors.append(f"Missing wrike.\{cf\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return errors\
\'a0\
def load_config(path: str) -> Config:\
\'a0\'a0\'a0 """Load and validate configuration"""\
\'a0\'a0\'a0 with open(path, "r", encoding="utf-8") as f:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 raw = yaml.safe_load(f)\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 if not isinstance(raw, dict):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 raise ValueError("Config YAML must be a mapping at the top level.")\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 config = Config(raw=raw)\
\'a0\'a0\'a0 errors = config.validate()\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 if errors:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 error_msg = "Configuration errors:\\n" + "\\n".join(f"\'a0 - \{e\}" for e in errors)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.error(error_msg)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 raise ValueError(error_msg)\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 logger.info(f"Configuration loaded from \{path\}")\
\'a0\'a0\'a0 return config\
\'a0\
# --- Enhanced HubSpot Client (with rate limiting and retries) ---\
class EnhancedHubSpotClient:\
\'a0\'a0\'a0 """Enhanced HubSpot client with better error handling"""\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def __init__(self, token: str, base_url: str = "https://api.hubapi.com"):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.base_url = base_url.rstrip("/")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.session = requests.Session()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.session.headers.update(\{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "Authorization": f"Bearer \{token\}",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "Content-Type": "application/json",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "Accept": "application/json",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \})\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.rate_limit_remaining = 100\'a0 # Track rate limits\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def _request_with_retry(self, method: str, path: str, **kwargs) -> requests.Response:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Make request with exponential backoff retry"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 max_retries = 5\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 backoff_factor = 2\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 for attempt in range(max_retries):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 try:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self.session.request(method, f"\{self.base_url\}\{path\}", \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 timeout=30, **kwargs)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Update rate limit tracking\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if 'X-HubSpot-RateLimit-Remaining' in response.headers:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.rate_limit_remaining = int(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response.headers['X-HubSpot-RateLimit-Remaining']\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 )\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if response.status_code == 429:\'a0 # Rate limited\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 wait_time = backoff_factor ** attempt\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.warning(f"Rate limited. Waiting \{wait_time\} seconds...")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 time.sleep(wait_time)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 continue\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if response.status_code >= 400:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.error(f"HubSpot error \{response.status_code\}: \{response.text\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if response.status_code >= 500 and attempt < max_retries - 1:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 time.sleep(backoff_factor ** attempt)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 continue\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response.raise_for_status()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return response\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 except requests.exceptions.RequestException as e:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.error(f"Request failed (attempt \{attempt + 1\}): \{e\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if attempt == max_retries - 1:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 raise\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 time.sleep(backoff_factor ** attempt)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 raise Exception("Max retries exceeded")\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 # Original methods from gpt-1, now using enhanced request method\
\'a0\'a0\'a0 def list_properties(self, object_type: str) -> List[Dict[str, Any]]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self._request_with_retry("GET", f"/crm/v3/properties/\{object_type\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 data = response.json()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return data.get("results", [])\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def search_objects(self, object_type: str, filter_groups: List[Dict[str, Any]], \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 properties: List[str], sorts: List[str], \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 after: Optional[str] = None, limit: int = 100) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 body = \{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "filterGroups": filter_groups,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "properties": properties,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "sorts": sorts,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "limit": limit,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if after is not None:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 body["after"] = after\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self._request_with_retry("POST", f"/crm/v3/objects/\{object_type\}/search", \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 json=body)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return response.json()\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def get_object(self, object_type: str, object_id: str, properties: List[str]) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 params = \{"properties": properties\}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self._request_with_retry("GET", \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 f"/crm/v3/objects/\{object_type\}/\{object_id\}", \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 params=params)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return response.json()\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def create_object(self, object_type: str, properties: Dict[str, Any]) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self._request_with_retry("POST", f"/crm/v3/objects/\{object_type\}", \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 json=\{"properties": properties\})\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return response.json()\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def update_object(self, object_type: str, object_id: str, properties: Dict[str, Any]) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self._request_with_retry("PATCH", \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 f"/crm/v3/objects/\{object_type\}/\{object_id\}", \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 json=\{"properties": properties\})\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return response.json()\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def find_contact_by_email(self, email: str, properties: List[str]) -> Optional[Dict[str, Any]]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 email = email.strip()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if not email:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return None\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 filters = [\{"filters": [\{"propertyName": "email", "operator": "EQ", "value": email\}]\}]\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 res = self.search_objects("contacts", filters, properties=properties, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 sorts=["hs_lastmodifieddate"], limit=2)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 results = res.get("results", [])\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return results[0] if results else None\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def associate_contact_to_company(self, contact_id: str, company_id: str) -> None:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Create contact-company association"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 path = f"/crm/v4/objects/contact/\{contact_id\}/associations/default/company/\{company_id\}"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self._request_with_retry("PUT", path)\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def batch_update_companies(self, companies: List[Dict]) -> Dict:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Batch update companies (more efficient for large syncs)"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 batch_data = \{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "inputs": companies\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self._request_with_retry("POST", "/crm/v3/objects/companies/batch/update", \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 json=batch_data)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return response.json()\
\'a0\
# --- Enhanced Wrike Client ---\
class EnhancedWrikeClient:\
\'a0\'a0\'a0 """Enhanced Wrike client with better error handling"""\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def __init__(self, token: str, base_url: str = "https://www.wrike.com/api/v4"):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.base_url = base_url.rstrip("/")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.session = requests.Session()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.session.headers.update(\{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "Authorization": f"Bearer \{token\}",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "Accept": "application/json",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \})\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def _request_with_retry(self, method: str, path: str, **kwargs) -> requests.Response:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Make request with exponential backoff retry"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 max_retries = 5\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 backoff_factor = 2\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 for attempt in range(max_retries):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 try:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self.session.request(method, f"\{self.base_url\}\{path\}", \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 timeout=30, **kwargs)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if response.status_code == 429:\'a0 # Rate limited\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 wait_time = backoff_factor ** attempt\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.warning(f"Wrike rate limited. Waiting \{wait_time\} seconds...")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 time.sleep(wait_time)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 continue\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if response.status_code >= 400:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.error(f"Wrike error \{response.status_code\}: \{response.text\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if response.status_code >= 500 and attempt < max_retries - 1:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 time.sleep(backoff_factor ** attempt)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 continue\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response.raise_for_status()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return response\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 except requests.exceptions.RequestException as e:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.error(f"Wrike request failed (attempt \{attempt + 1\}): \{e\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if attempt == max_retries - 1:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 raise\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 time.sleep(backoff_factor ** attempt)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 raise Exception("Max retries exceeded")\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 # Original methods from gpt-1, now using enhanced request method\
\'a0\'a0\'a0 def list_custom_fields(self) -> List[Dict[str, Any]]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self._request_with_retry("GET", "/customfields")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 data = response.json()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return data.get("data", [])\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def query_tasks_in_folder_updated_between(self, folder_id: str, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 start_dt: datetime, end_dt: datetime, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 descendants: bool = True, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 page_size: int = 100) -> Iterable[Dict[str, Any]]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 next_token = None\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 updated_date = json.dumps(\{"start": start_dt.isoformat(), "end": end_dt.isoformat()\})\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 while True:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 params = \{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "descendants": "true" if descendants else "false",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "pageSize": str(page_size),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "updatedDate": updated_date,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if next_token:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 params["nextPageToken"] = next_token\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self._request_with_retry("GET", f"/folders/\{folder_id\}/tasks", \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 params=params)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 data = response.json()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 for task in data.get("data", []):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 yield task\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 next_token = data.get("nextPageToken")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if not next_token:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 break\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def query_tasks_in_folder_by_custom_field(self, folder_id: str, custom_field_id: str, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 value: str, descendants: bool = True, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 page_size: int = 100) -> List[Dict[str, Any]]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 cf = json.dumps(\{"id": custom_field_id, "value": value\})\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 params = \{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "descendants": "true" if descendants else "false",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "pageSize": str(page_size),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "customField": cf,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self._request_with_retry("GET", f"/folders/\{folder_id\}/tasks", \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 params=params)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 data = response.json()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return data.get("data", [])\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def create_task(self, folder_id: str, title: str, custom_fields: List[Dict[str, Any]]) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 data = \{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "title": title,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "customFields": json.dumps(custom_fields),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self._request_with_retry("POST", f"/folders/\{folder_id\}/tasks", data=data)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 items = response.json().get("data", [])\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if not items:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 raise Exception("Wrike create task returned no data.")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return items[0]\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def update_task(self, task_id: str, title: Optional[str], \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 custom_fields: Optional[List[Dict[str, Any]]]) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 data = \{\}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if title is not None:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 data["title"] = title\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if custom_fields is not None:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 data["customFields"] = json.dumps(custom_fields)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self._request_with_retry("PUT", f"/tasks/\{task_id\}", data=data)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 items = response.json().get("data", [])\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if not items:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 raise Exception("Wrike update task returned no data.")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return items[0]\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def get_task(self, task_id: str) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Get specific task by ID"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 response = self._request_with_retry("GET", f"/tasks/\{task_id\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 items = response.json().get("data", [])\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if not items:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 raise Exception(f"Task \{task_id\} not found")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return items[0]\
\'a0\
# --- Utility Functions ---\
def wrike_cf_get(task: Dict[str, Any], cf_id: str) -> Optional[str]:\
\'a0\'a0\'a0 """Get custom field value from Wrike task"""\
\'a0\'a0\'a0 for cf in task.get("customFields", []) or []:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if cf.get("id") == cf_id:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 v = cf.get("value")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if v is None:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return None\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return str(v)\
\'a0\'a0\'a0 return None\
\'a0\
def wrike_cf_set(custom_fields: List[Dict[str, Any]], cf_id: str, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 value: Optional[str]) -> List[Dict[str, Any]]:\
\'a0\'a0\'a0 """Set custom field value for Wrike task"""\
\'a0\'a0\'a0 value = None if value is None else str(value)\
\'a0\'a0\'a0 out = [dict(x) for x in (custom_fields or []) if x.get("id") != cf_id]\
\'a0\'a0\'a0 if value is not None and value.strip() != "":\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 out.append(\{"id": cf_id, "value": value\})\
\'a0\'a0\'a0 return out\
\'a0\
def safe_str(x: Any) -> str:\
\'a0\'a0\'a0 """Safely convert to string"""\
\'a0\'a0\'a0 if x is None:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return ""\
\'a0\'a0\'a0 return str(x).strip()\
\'a0\
def map_tier_to_priority(tier: str, mapping: Dict[str, str]) -> str:\
\'a0\'a0\'a0 """Map Falcon tier to HubSpot priority"""\
\'a0\'a0\'a0 t = safe_str(tier)\
\'a0\'a0\'a0 if not t:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return ""\
\'a0\'a0\'a0 return mapping.get(t, t)\
\'a0\
def map_priority_to_tier(priority: str, mapping: Dict[str, str]) -> str:\
\'a0\'a0\'a0 """Map HubSpot priority to Falcon tier"""\
\'a0\'a0\'a0 p = safe_str(priority)\
\'a0\'a0\'a0 if not p:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return ""\
\'a0\'a0\'a0 return mapping.get(p, p)\
\'a0\
def utc_now() -> datetime:\
\'a0\'a0\'a0 return datetime.now(timezone.utc)\
\'a0\
def to_iso_z(dt: datetime) -> str:\
\'a0\'a0\'a0 dt = dt.astimezone(timezone.utc)\
\'a0\'a0\'a0 return dt.replace(microsecond=0).isoformat().replace("+00:00", "Z")\
\'a0\
def to_epoch_ms(dt: datetime) -> int:\
\'a0\'a0\'a0 return int(dt.timestamp() * 1000)\
\'a0\
# --- Enhanced Sync Engine ---\
class EnhancedSyncEngine:\
\'a0\'a0\'a0 """Enhanced sync engine with all integrated features"""\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def __init__(self, cfg: Config, db: EnhancedDB, hub: EnhancedHubSpotClient, \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 wrk: EnhancedWrikeClient):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.cfg = cfg\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.db = db\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.hub = hub\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.wrk = wrk\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.hp_company_props = cfg.hubspot["company_properties"]\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.hp_contact_props = cfg.hubspot["contact_properties"]\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.w_company_cf = cfg.wrike["company_custom_fields"]\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.w_contact_cf = cfg.wrike["contact_custom_fields"]\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.sync_opts = cfg.sync\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.tier_to_priority = self.sync_opts.get("tier_to_priority", \{\})\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.priority_to_tier = self.sync_opts.get("priority_to_tier", \{\})\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Environment-specific settings\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.is_production = cfg.environment == "production"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0 def verify(self) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Verify all configurations and return report"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info("Verifying system configuration...")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report = \{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "timestamp": utc_now().isoformat(),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "hubspot": \{"status": "pending", "missing_properties": []\},\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "wrike": \{"status": "pending", "missing_fields": []\},\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "mappings": \{"status": "pending"\},\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "environment": self.cfg.environment,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "notes": []\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 try:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Verify HubSpot properties\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info("Verifying HubSpot properties...")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 company_props = \{p.get("name") for p in self.hub.list_properties("companies")\}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 contact_props = \{p.get("name") for p in self.hub.list_properties("contacts")\}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 required_company = set(self.hp_company_props.values())\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 required_contact = set(self.hp_contact_props.values())\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 missing_company = [p for p in required_company if p not in company_props]\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 missing_contact = [p for p in required_contact if p not in contact_props]\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if missing_company or missing_contact:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["hubspot"]["status"] = "failed"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["hubspot"]["missing_properties"] = missing_company + missing_contact\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["notes"].append("Missing HubSpot properties")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 else:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["hubspot"]["status"] = "passed"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Verify Wrike custom fields\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info("Verifying Wrike custom fields...")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 wrike_fields = \{f.get("id") for f in self.wrk.list_custom_fields()\}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 required_wrike = set(self.w_company_cf.values()) | set(self.w_contact_cf.values())\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 missing_wrike = [cf for cf in required_wrike if cf not in wrike_fields]\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if missing_wrike:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["wrike"]["status"] = "failed"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["wrike"]["missing_fields"] = missing_wrike\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["notes"].append("Missing Wrike custom fields")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 else:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["wrike"]["status"] = "passed"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Verify field mappings\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info("Verifying field mappings...")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 mapping_errors = []\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Check tier mappings\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 for tier in ["Tier 1", "Tier 2", "Tier 3", "1", "2", "3"]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if tier not in self.tier_to_priority:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 mapping_errors.append(f"Missing tier mapping: \{tier\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 for priority in ["High", "Medium", "Low"]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if priority not in self.priority_to_tier:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 mapping_errors.append(f"Missing priority mapping: \{priority\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if mapping_errors:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["mappings"]["status"] = "failed"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["mappings"]["errors"] = mapping_errors\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["notes"].append("Missing tier/priority mappings")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 else:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["mappings"]["status"] = "passed"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Overall status\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 all_passed = all([\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["hubspot"]["status"] == "passed",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["wrike"]["status"] == "passed",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["mappings"]["status"] == "passed"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 ])\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["overall_status"] = "PASSED" if all_passed else "FAILED"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if all_passed:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info("Verification PASSED")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 else:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.error("Verification FAILED")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.error(f"Report: \{json.dumps(report, indent=2)\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return report\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 except Exception as e:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.error(f"Verification failed with error: \{e\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["overall_status"] = "ERROR"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report["error"] = str(e)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return report\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def generate_mapping_report(self) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Generate comprehensive mapping report (from ds-1)"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 report = \{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "timestamp": utc_now().isoformat(),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "company_field_mappings": self.hp_company_props,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "contact_field_mappings": self.hp_contact_props,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "wrike_company_fields": self.w_company_cf,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "wrike_contact_fields": self.w_contact_cf,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "tier_mapping": self.tier_to_priority,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "priority_mapping": self.priority_to_tier,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "database_stats": self.db.get_company_mappings_report(),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "sync_settings": \{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "polling_interval": self.sync_opts.get("polling_interval_seconds"),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "create_missing_companies": self.sync_opts.get("create_missing_companies_in_hubspot", True),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "bidirectional_contacts": self.sync_opts.get("sync_contacts_hubspot_to_wrike", False),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "environment": self.cfg.environment\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return report\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 def sync_once(self) -> Dict[str, Any]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Run one complete sync cycle"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info("Starting sync cycle...")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 results = \{\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "start_time": utc_now().isoformat(),\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "companies_to_hubspot": \{"processed": 0, "created": 0, "updated": 0, "failed": 0\},\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "contacts_to_hubspot": \{"processed": 0, "created": 0, "updated": 0, "failed": 0\},\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "companies_to_wrike": \{"processed": 0, "updated": 0, "failed": 0\},\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "contacts_to_wrike": \{"processed": 0, "updated": 0, "failed": 0\},\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "issues_found": 0,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "end_time": None,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 "duration_seconds": None\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 start_time = utc_now()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 try:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Sync companies from Wrike to HubSpot\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info("Syncing companies from Wrike to HubSpot...")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 company_results = self.sync_wrike_to_hubspot_companies()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 results["companies_to_hubspot"].update(company_results)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Sync contacts from Wrike to HubSpot\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info("Syncing contacts from Wrike to HubSpot...")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 contact_results = self.sync_wrike_to_hubspot_contacts()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 results["contacts_to_hubspot"].update(contact_results)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Sync companies from HubSpot to Wrike\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info("Syncing companies from HubSpot to Wrike...")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 hubspot_company_results = self.sync_hubspot_to_wrike_companies()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 results["companies_to_wrike"].update(hubspot_company_results)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Optional: Sync contacts from HubSpot to Wrike\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 if self.sync_opts.get("sync_contacts_hubspot_to_wrike", False):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info("Syncing contacts from HubSpot to Wrike...")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 hubspot_contact_results = self.sync_hubspot_to_wrike_contacts()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 results["contacts_to_wrike"].update(hubspot_contact_results)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Count issues\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 issues = self.db.list_unresolved_issues()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 results["issues_found"] = len(issues)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Calculate duration\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 end_time = utc_now()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 results["end_time"] = end_time.isoformat()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 results["duration_seconds"] = (end_time - start_time).total_seconds()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info(f"Sync completed in \{results['duration_seconds']:.2f\} seconds")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info(f"Results: \{json.dumps(results, indent=2)\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 # Log sync summary\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.db.log_sync_operation(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 operation="full_sync",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 source="middleware",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 target="both",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 entity_type="all",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 entity_id=None,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 status="success",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 message=f"Processed \{results['companies_to_hubspot']['processed']\} companies, "\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 f"\{results['contacts_to_hubspot']['processed']\} contacts"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 )\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 return results\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 except Exception as e:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.error(f"Sync failed: \{e\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 self.db.log_sync_operation(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 operation="full_sync",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 source="middleware",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 target="both",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 entity_type="all",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 entity_id=None,\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 status="failed",\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 message=str(e)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 )\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 raise\
\'a0\'a0\'a0 \
\'a0\'a0\'a0 # Original sync methods from gpt-1 (with enhanced logging)\
\'a0\'a0\'a0 def sync_wrike_to_hubspot_companies(self) -> Dict[str, int]:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 """Sync companies from Wrike to HubSpot"""\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 companies_folder = self.cfg.wrike["companies_folder_id"]\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 state_key = "wrike_to_hubspot_last_run"\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 last = self.db.get_state(state_key)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 start = dtparser.parse(last) if last else (utc_now() - timedelta(days=7))\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 end = utc_now()\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 logger.info(f"Scanning Wrike company updates between \{start\} and \{end\}")\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 results = \{"processed": 0, "created": 0, "updated": 0, "failed": 0\}\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 for task in self.wrk.query_tasks_in_folder_updated_between(\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 companies_folder, start, end, descendants=True\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0 ):\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 try:\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 wrike_task_id = safe_str(task.get("id"))\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 results["processed"] += 1\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 \
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 hubspot_company_id = self.db.get_hubspot_company_id(wrike_task_id)\
\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0\'a0 hs\
}